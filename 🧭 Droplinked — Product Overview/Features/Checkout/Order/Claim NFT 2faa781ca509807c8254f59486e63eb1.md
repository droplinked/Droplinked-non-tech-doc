# Claim NFT

# Claim NFT

### Feature ID:

**[WEB3-CNFT-005]**

### Title:

**Claim NFT**

### Category:

**Web3 / Order** | **Actors**: Customer | **Channel**: Storefront (Order Confirmation Page)

### Status:

**Defined**

### Owner:

Behdad

---

## PART 1: HUMAN-CENTRIC LAYER

---

### 1) **Summary**

**Problem/Value:**
After purchasing a product that has been recorded as an NFT, customers need a secure and reliable mechanism to claim ownership of the NFT and transfer it to their personal wallet. Without a clear claim process, customers cannot verify their digital ownership or access the blockchain benefits of their purchase.

**Desired Outcome:**

- Customers see all NFTs associated with their purchased products on the Order Confirmation Page.
- Customers can connect their wallet (Phantom or MetaMask) and claim NFTs with a single click.
- The claim process handles wallet connection, extension availability, and transfer status transparently.
- Upon successful claim, customers can view the NFT in their wallet and verify the transaction on the blockchain.
- Both customers and merchants can view the transaction hash as proof of transfer.

---

### 2) **Scope â€“ In / Out**

**In Scope:**

- **NFT Display:** List of claimable NFTs on Order Confirmation Page.
- **Wallet Support:** Phantom and MetaMask wallet extensions.
- **Wallet Connection Check:** Detect if wallet extension is installed and connected.
- **Extension Installation Prompt:** Guide user to install wallet extension if missing.
- **Claim Button:** Initiate NFT transfer to connected wallet.
- **Pending State:** Visual indicator during transfer process.
- **Retry Mechanism:** Allow unlimited retry attempts on failure.
- **Success State:** Display "NFT Claimed" status with blockchain link.
- **Transaction Recording:** Save TX Hash to Order record.
- **View on Blockchain:** Link to block explorer for transaction verification.
- **View on Wallet:** Link to view NFT in wallet interface.

**Out of Scope:**

- NFT minting/recording (Handled by Record NFT feature).
- Automatic NFT transfer without customer action.
- Multi-chain bridging.
- NFT resale or marketplace features.
- Wallet creation or key management.
- Network/chain selection (determined by product's NFT chain).

---

### 3) **Key User Journeys**

---

**Journey 1: View Claimable NFTs**

| Step | Actor | Action | System Response |
| --- | --- | --- | --- |
| 1 | Customer | Completes purchase of NFT-recorded product | Order created with NFT claim entitlement |
| 2 | Customer | Views Order Confirmation Page | NFT section displays with product info and "Claim NFT" button |
| 3 | Customer | Sees NFT count and product details | Each NFT shows: thumbnail, title, claim status |

---

**Journey 2: Claim NFT with Connected Wallet**

| Step | Actor | Action | System Response |
| --- | --- | --- | --- |
| 1 | Customer | Has wallet extension installed and connected | Wallet icon shows connected status |
| 2 | Customer | Clicks "Claim NFT" button | System initiates transfer transaction |
| 3 | Customer | Approves transaction in wallet popup | NFT enters "Pending" state |
| 4 | System | Transaction confirms on blockchain | Status updates to "NFT Claimed" |
| 5 | Customer | Views claimed NFT | "View on Blockchain" and "View on Wallet" links appear |

---

**Journey 3: Claim NFT Without Wallet Extension**

| Step | Actor | Action | System Response |
| --- | --- | --- | --- |
| 1 | Customer | Clicks "Claim NFT" without extension installed | System detects missing extension |
| 2 | System | Shows "Install Chrome Extension" prompt | Link to Chrome Web Store |
| 3 | Customer | Installs extension and refreshes page | Wallet options now available |
| 4 | Customer | Connects wallet and claims NFT | Normal claim flow proceeds |

---

**Journey 4: Claim NFT with Disconnected Wallet**

| Step | Actor | Action | System Response |
| --- | --- | --- | --- |
| 1 | Customer | Has extension but wallet not connected | System detects disconnected state |
| 2 | Customer | Clicks "Claim NFT" | Wallet connection prompt appears |
| 3 | Customer | Approves connection in wallet | Wallet connects to site |
| 4 | Customer | Clicks "Claim NFT" again | Transfer initiates |

---

**Journey 5: Retry Failed Claim**

| Step | Actor | Action | System Response |
| --- | --- | --- | --- |
| 1 | Customer | Claim transaction fails (network error, rejected, etc.) | Error message displayed |
| 2 | Customer | Clicks "Retry Claim" | New transfer attempt initiated |
| 3 | System | Transaction succeeds | NFT claimed successfully |

---

**Journey 6: Verify Transaction on Blockchain**

| Step | Actor | Action | System Response |
| --- | --- | --- | --- |
| 1 | Customer | NFT successfully claimed | "View on Blockchain" link appears |
| 2 | Customer | Clicks "View on Blockchain" | New tab opens with block explorer |
| 3 | Customer | Views transaction details | TX hash, from/to addresses, timestamp visible |

---

### 4) **Business Acceptance Criteria (BAC)**

| ID | Criteria | Pass/Fail |
| --- | --- | --- |
| BAC-1 | NFT section displays on Order Confirmation Page when order contains recorded NFT products |  |
| BAC-2 | Each NFT shows product thumbnail, title, and claim button |  |
| BAC-3 | System detects if wallet extension (Phantom/MetaMask) is installed |  |
| BAC-4 | User is prompted to install extension if not present |  |
| BAC-5 | System detects if wallet is connected to the site |  |
| BAC-6 | User can connect wallet before claiming |  |
| BAC-7 | Clicking "Claim NFT" initiates blockchain transfer transaction |  |
| BAC-8 | NFT shows "Pending" state during transfer |  |
| BAC-9 | Successful transfer updates status to "NFT Claimed" |  |
| BAC-10 | Failed transfer shows error message with "Retry" option |  |
| BAC-11 | No limit on retry attempts |  |
| BAC-12 | Transaction Hash (TX ID) is saved to Order record on success |  |
| BAC-13 | "View on Blockchain" link opens block explorer with transaction details |  |
| BAC-14 | "View on Wallet" link allows customer to see NFT in wallet interface |  |
| BAC-15 | Merchant can view TX Hash in Order Management dashboard |  |

---

### ğŸ“œ Change Log

| Date | Author | Description of Changes | Reason |
| --- | --- | --- | --- |
| 2026-02-01 | Behdad | Initial document creation | New Feature Definition |

---

---

## PART 2: AI-CENTRIC LAYER (Functional Logic Depth)

---

### B1) Definitions & Glossary

| Term | Definition |
| --- | --- |
| **Recorded NFT** | A product that has been minted as an NFT on the blockchain by the merchant |
| **Claim** | The process of transferring NFT ownership from merchant/platform wallet to customer wallet |
| **TX Hash** | Transaction Hash - unique identifier for a blockchain transaction |
| **Block Explorer** | Website that displays blockchain transaction details (e.g., PolygonScan, Solscan) |
| **Wallet Extension** | Browser extension that manages cryptocurrency wallets (Phantom, MetaMask) |

---

### B2) Exhaustive Functional Logic

---

### **FL-1: NFT Section Visibility Logic**

| Condition | Result |
| --- | --- |
| Order contains at least one product with `has_nft = true` | NFT section is displayed |
| Order contains no NFT products | NFT section is hidden |
| Multiple NFT products in order | Each NFT displayed as separate item |
| Same product purchased multiple times | Each unit shows as separate claimable NFT |

---

### **FL-2: NFT Item Display Logic**

For each NFT in Order:

| Element | Source | Display |
| --- | --- | --- |
| Thumbnail | product.thumbnail_url | Product image |
| Title | product.title | Product name |
| Quantity indicator | order_item.quantity | "2" badge if multiple |
| Claim Status | nft_claim.status | Button or status text |
| Blockchain Link | nft_claim.tx_hash | "View on Blockchain" (after claim) |
| Wallet Link | Generated from chain + token | "View on Wallet" (after claim) |

---

### **FL-3: Wallet Detection Logic**

```
ON Page Load:
    Check if window.phantom exists â†’ Phantom installed
    Check if window.ethereum exists â†’ MetaMask installed

    FOR each installed wallet:
        Check connection status
        IF connected:
            Display wallet address (truncated)
        ELSE:
            Display "Connect" button

```

| Wallet | Detection Method | Connection Check |
| --- | --- | --- |
| Phantom | `window.phantom?.solana` | `phantom.solana.isConnected` |
| MetaMask | `window.ethereum?.isMetaMask` | `ethereum.selectedAddress !== null` |

---

### **FL-4: Claim Button State Logic**

| State | Button Text | Button Style | Clickable |
| --- | --- | --- | --- |
| Not Claimed + No Wallet | "Claim NFT" | Primary | Yes |
| Not Claimed + Wallet Installed | "Claim NFT" | Primary | Yes |
| Claiming (Pending) | "Claiming..." | Disabled/Loading | No |
| Claimed | "NFT Claimed" | Success/Green | No |
| Failed | "Retry Claim" | Warning/Orange | Yes |

---

### **FL-5: Claim Process Logic**

```
ON "Claim NFT" Click:

    STEP 1: Check Wallet Extension
    IF wallet extension NOT installed:
        Show "Install Chrome Extension" with store link
        RETURN

    STEP 2: Check Wallet Connection
    IF wallet NOT connected:
        Trigger wallet connection popup
        WAIT for connection approval
        IF rejected:
            Show "Connection rejected" message
            RETURN

    STEP 3: Verify Wallet Address
    GET connected wallet address

    STEP 4: Initiate Transfer
    SET nft_claim.status = PENDING
    CALL blockchain transfer function

    STEP 5: Wait for Confirmation
    AWAIT transaction confirmation

    STEP 6a: On Success
    SET nft_claim.status = CLAIMED
    SAVE tx_hash to order record
    Display "NFT Claimed" status
    Show "View on Blockchain" link
    Show "View on Wallet" link

    STEP 6b: On Failure
    SET nft_claim.status = FAILED
    Display error message
    Show "Retry Claim" button

```

---

### **FL-6: Transaction Hash Storage**

| Event | Action |
| --- | --- |
| Transfer transaction broadcast | Store pending TX hash |
| Transaction confirmed | Update order record with final TX hash |
| Transaction failed | Clear pending TX hash, log error |

**Order Record Update:**

```
order.nft_claims[item_id] = {
    status: "CLAIMED",
    tx_hash: "0x123...abc",
    claimed_at: timestamp,
    wallet_address: "0xdef...789"
}

```

---

### **FL-7: Block Explorer Link Generation**

| Chain | Explorer Base URL | Link Format |
| --- | --- | --- |
| Polygon | [polygonscan.com](http://polygonscan.com/) | `https://polygonscan.com/tx/{tx_hash}` |
| Solana | [solscan.io](http://solscan.io/) | `https://solscan.io/tx/{tx_hash}` |
| Ethereum | [etherscan.io](http://etherscan.io/) | `https://etherscan.io/tx/{tx_hash}` |

---

### B3) Behavioral Flow

```
[Order Confirmation Page Loads]
    â†“
[Check: Order has NFT products?]
    â”œâ”€ NO â†’ [NFT Section Hidden]
    â””â”€ YES â†“
[Render NFT Section]
    â†“
[For Each NFT Product:]
    â†“
[Display Product Info + Claim Status]
    â†“
[User Clicks "Claim NFT"]
    â†“
[Check Wallet Extension Installed?]
    â”œâ”€ NO â†’ [Show Install Extension Prompt] â†’ [User Installs] â†’ [Refresh]
    â””â”€ YES â†“
[Check Wallet Connected?]
    â”œâ”€ NO â†’ [Trigger Connection Popup] â†’ [User Approves] â†“
    â””â”€ YES â†“
[Initiate Blockchain Transfer]
    â†“
[Set Status: PENDING]
    â†“
[Wait for Transaction Confirmation]
    â†“
[Transaction Result]
    â”œâ”€ FAILED â†’ [Show Error + Retry Button]
    â””â”€ SUCCESS â†“
[Set Status: CLAIMED]
    â†“
[Save TX Hash to Order]
    â†“
[Display Blockchain & Wallet Links]

```

---

### B4) State Transitions

| Current State | Trigger | New State | Side Effects |
| --- | --- | --- | --- |
| NOT_CLAIMED | Click "Claim NFT" (no wallet) | NOT_CLAIMED | Install prompt shown |
| NOT_CLAIMED | Click "Claim NFT" (wallet ready) | PENDING | Transfer initiated |
| PENDING | Transaction confirmed | CLAIMED | TX hash saved, links shown |
| PENDING | Transaction failed | FAILED | Error message shown |
| FAILED | Click "Retry Claim" | PENDING | New transfer attempt |

**State Diagram:**

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ NOT_CLAIMED  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚ Click Claim (wallet ready)
                           â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚   PENDING    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
         â”‚ Fail                             â”‚ Success
         â–¼                                  â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  FAILED  â”‚â”€â”€â”€â”€ Retry â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚   CLAIMED    â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

```

---

### B5) Edge Cases & Error Handling

| Edge Case | System Behavior |
| --- | --- |
| **EC-1:** User rejects wallet connection | Show "Connection rejected. Please approve to claim your NFT." |
| **EC-2:** User rejects transaction | Show "Transaction cancelled. Click Retry to try again." |
| **EC-3:** Network error during transfer | Show "Network error. Please check your connection and retry." |
| **EC-4:** Insufficient gas in wallet | Show "Insufficient funds for transaction fee." |
| **EC-5:** Wallet extension crashes | Show "Wallet error. Please refresh and try again." |
| **EC-6:** User switches wallet account mid-claim | Cancel pending operation, prompt to restart |
| **EC-7:** Page refresh during pending claim | Re-check blockchain for transaction status, update accordingly |
| **EC-8:** Multiple NFTs, some claimed some not | Each NFT maintains independent status |
| **EC-9:** User closes browser during pending | On return, check blockchain status and update UI |
| **EC-10:** Blockchain congestion (slow confirmation) | Keep pending state, show "This may take a few minutes" |

---

### B6) Data Requirements

**NFT Claim Object:**

| Field | Type | Description |
| --- | --- | --- |
| order_id | String | Parent order identifier |
| order_item_id | String | Specific line item in order |
| product_id | String | Product identifier |
| nft_token_id | String | Blockchain token identifier |
| chain | Enum | POLYGON, SOLANA, ETHEREUM |
| status | Enum | NOT_CLAIMED, PENDING, CLAIMED, FAILED |
| tx_hash | String (nullable) | Transaction hash after claim |
| wallet_address | String (nullable) | Customer's wallet address |
| claimed_at | DateTime (nullable) | Timestamp of successful claim |
| error_message | String (nullable) | Last error message if failed |

---

### B7) Test Case Hooks

| Test ID | Scenario | Expected Result |
| --- | --- | --- |
| TC-1 | Order with 1 NFT product | NFT section shows with claim button |
| TC-2 | Order with 3 NFT products | 3 separate NFT items displayed |
| TC-3 | Order with no NFT products | NFT section hidden |
| TC-4 | Claim without wallet extension | Install prompt shown |
| TC-5 | Claim with disconnected wallet | Connection popup triggered |
| TC-6 | Successful claim | Status changes to CLAIMED, links appear |
| TC-7 | Failed claim (network error) | Error message + Retry button shown |
| TC-8 | Retry after failure | New attempt initiated |
| TC-9 | View on Blockchain click | Opens block explorer with TX |
| TC-10 | View on Wallet click | Opens wallet interface |
| TC-11 | Multiple retries | All attempts allowed |
| TC-12 | Refresh page during pending | Correct status reflected |
| TC-13 | TX hash saved to order | Verify in database |
| TC-14 | Merchant views TX in dashboard | TX hash visible in order details |