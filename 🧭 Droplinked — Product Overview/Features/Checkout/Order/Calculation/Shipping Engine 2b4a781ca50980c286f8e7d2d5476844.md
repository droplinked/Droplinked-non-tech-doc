# Shipping Engine

**Feature ID:** CHK-SHIPPING-002

**Category:** Checkout Domain | Cost Engines

**Actors:** Checkout Service, External Shipping Providers, Product Engine

**Status:** Released

**Owner:** Behdad

---

# **1) Summary**

## **Problem / Value**

The platform must support **two types of shipping systems** for every cart:

1. **External Shipping Providers** (Printful, EasyPost, others)
2. **Internal Shipping** configured manually by merchants

The shipping engine must be able to:

- Group items by shipping provider
- Build shipping groups for the user to choose from
- Calculate total shipping cost
- Provide shipping data to the Cart Calculation Engine and Order Engine
- Support multiple shipping groups selected at checkout

This engine is **independent of UI**, payment, or order creation.

## **Desired Outcome**

A modular shipping engine that:

- Builds shipping groups
- Calculates shipping cost for each group
- Supports internal + external providers
- Returns a normalized **ShippingSummary Object**
- Is fully deterministic and testable

---

# **2) Scope**

### **In Scope**

- Internal shipping rules
- External provider shipping calculation
- Per-provider shipping groups
- Cost calculation for each shipping option
- Merging shipping results
- Returning user-selectable shipping methods

### **Out of Scope**

- Tax calculation (separate engine)
- Payment routing
- Affiliate/commission logic
- Order creation
- UI rendering
- Rate-limiting external provider calls

---

# **3) Business Logic**

## **3.1 Shipping Types**

Shipping in the system has **two major categories**:

---

## **A) External Shipping**

Products that rely on 3rd-party shipping services:

- Printful
- EasyPost
- Any future external shipping integrations

For each provider:

- The engine requests shipping options
- Each option includes:

```
serviceName
amount
fulfillmentDate
estimatedDelivery
provider
itemsIncluded[]

```

External shipping cost is part of:

```
externalShippingCost
externalServiceCosts (for commission engine)

```

---

## **B) Internal Shipping**

Products that use merchant-defined shipping rules:

- Flat rate
- Conditional shipping (weight/price/country-based)
- Free shipping rules

For internal shipping groups:

```
serviceName
amount
estimatedDelivery
merchantDefined
itemsIncluded[]

```

---

# **4) Shipping Grouping Rules**

### **Rule 1 — Items Are Grouped by Shipping Provider**

Example groups:

- Printful group
- EasyPost group
- Merchant’s internal shipping group

Each group contains the set of products that require this provider.

---

### **Rule 2 — Each Group Has Multiple Shipping Options**

Example (Printful group):

- Standard (default)
- Express
- Priority

Example (Internal group):

- Merchant Standard (default)
- Merchant Expedited

---

### **Rule 3 — Default Selection**

For each group, the **first option** is automatically selected.

---

### **Rule 4 — Final Shipping Cost**

```
TotalShipping = sum(selectedOption.cost for each group)

```

---

# **5) Shipping Calculation Flow**

### **Step 1 — Identify Items and Providers**

Engine receives the full cart, including item metadata:

- product type
- provider type
- weight, dimensions, origin, destination
- merchant internal shipping rules

---

### **Step 2 — Group Items**

Items are grouped by their shipping provider.

Result example:

```
shippingGroups = {
  printful: [...items],
  internal: [...items],
  easypost: [...items]
}

```

---

### **Step 3 — Fetch Rates**

For each group:

- External providers → API call
- Internal providers → merchant rules → calculated rates

---

---

### **Step 5 — Calculate Total Shipping**

When user selects options:

```
TotalShipping = sum(option.amount for every group)

```

This number is passed to:

- Cart Calculation Engine (001)
- Order Creation Engine (007)
- Commission Engine (004)

---

# **7) Business Acceptance Criteria (BAC)**

1. Shipping must be grouped by provider (Printful, EasyPost, internal).
2. Each group must have 1+ shipping options returned.
3. The first option for each group must be the default.
4. Total shipping = sum of selected shipping options.
5. External provider shipping cost must be returned exactly as received.
6. External provider shipping cost must also be passed to the Commission Engine as **externalServiceCosts**.
7. Internal shipping must respect merchant-defined rules.
8. Digital items must not appear in any shipping group.
9. POD items must be routed to Printful (or POD provider).
10. The ShippingSummary object must comply with the defined schema.
11. If an external API fails, proper fallbacks or error handling must occur.

---

# **8) Dependencies**

- **001 Cart Calculation Engine** (uses `totalShipping`)
- **003 Tax Engine** (physical/POD tax requires shipping info)
- **004 Commission Engine** (external shipping cost)
- **007 Order Creation Engine** (validates shipping selections)