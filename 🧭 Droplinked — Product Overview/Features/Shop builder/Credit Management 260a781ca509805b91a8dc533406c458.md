# Credit Management

### Feature ID:

**CRED-ANALYTICS-001**

### Title:

**Credit Management & Activity Analytics Page**

### Category:

**Merchant Dashboard / Analytics** | **Actors**: Merchant, Super Admin, System | **Channel**: Dashboard (`/analytics/credits-and-activity`)

### Status:

**Defined**

### Owner:

Behdad

---

### 1) **Summary**

**Problem/Value:**

Merchants need full visibility into how their shop credit changes over time, including credits added by the platform (rewards, referral payouts), debits (settlements, fees), and self-initiated top-ups. Without a unified view and downloadable invoices, merchants cannot reconcile their credit usage or understand the impact of operational events.

**Desired Outcome:**

- A dedicated analytics page at `/analytics/credits-and-activity` showing current credit balance and full transaction history.
- Filterable, sortable logs for every credit increase or decrease with clear reasons.
- Ability to **charge credit** (add funds) using fiat payment directly from the page.
- Download invoices for any transaction for accounting purposes.

---

### 2) **Scope – In / Out**

**In:**

- Display current **credit balance** at the top of the page.
- List all **credit transactions** with:
    - **Type** (increase/decrease, source).
    - **Title** (short label).
    - **Description** (detailed reason).
    - **Amount** (with +/− sign).
    - **Status** (pending, completed, failed).
    - **Transaction ID**.
- **Filters & Sorting**:
    - Filter by transaction type (credit add, credit deduct).
    - Filter by status.
    - Filter by time range.
    - Sort by date or amount.
- Show **summaries** for total credit added and total credit deducted within the selected period.
- Ability to **charge/add credit** using fiat payment:
    - Opens a payment flow (e.g., Stripe).
    - On success, credit balance increases and new transaction logged.
- Downloadable **invoice/receipt** per transaction.

**Out:**

- Bank payout requests or withdrawals (handled separately).
- Direct admin-side adjustments UI (done in super admin panel).
- Non-credit analytics (handled in other dashboards).

---

### 3) **Credit Event Sources**

Every credit increase or decrease must appear in the log with a clear type and description. Typical sources:

- **Charged by Super Admin** (manual adjustments by platform staff).
- **Merchant Self-Top-Up** (merchant charges credit via dashboard).
- **Enterprise Subscription Renewal** (automatic credit adjustment).
- **Subscription Renewal** (activated from admin panel or partner channel).
- **Order Settlement** (order payments can increase or decrease credit, e.g. shortfall debits or affiliate/referrer credits).
- **Referral Purchase** (when a referred shop makes a sale, the referring merchant’s share is added as credit).

Each event records:

- Date/time.
- Initiator (system/admin/merchant).
- Linked order or subscription ID (if applicable).
- Reference (payment ID, tx hash, Stripe charge ID, etc.).

---

### 4) **Key User Journeys**

- **Journey 1 – View Balance & Logs**
    - **Trigger:** Merchant visits `/analytics/credits-and-activity`.
    - **Action:** Page shows current credit balance and a paginated list of transactions. Merchant applies filters or sorts logs.
    - **Outcome:** Merchant can see and export a clear audit trail.
- **Journey 2 – Add Credit via Fiat Payment**
    - **Trigger:** Merchant clicks “Add Credit” button.
    - **Action:** Stripe payment modal opens; merchant completes payment.
    - **Outcome:** On success, credit balance increases immediately; transaction logged with downloadable invoice.
- **Journey 3 – Download Invoice**
    - **Trigger:** Merchant clicks “Download Invoice” on a transaction.
    - **Action:** System generates or retrieves invoice PDF with transaction details.
    - **Outcome:** Merchant obtains invoice for accounting.
- **Journey 4 – Audit Referral Payout**
    - **Trigger:** A referred shop makes a sale.
    - **Action:** System automatically credits the referring merchant’s account and logs transaction as “Referral Purchase.”
    - **Outcome:** Merchant sees new credit entry tied to referral.

---

### 5) **Business Acceptance Criteria (BAC)**

- **BAC 1:** Page displays the current credit balance correctly in real time → Pass/Fail.
- **BAC 2:** All credit transactions (increases and decreases) are listed with type, title, description, amount, status, and ID → Pass/Fail.
- **BAC 3:** Filters by type, status, and time period work and update totals (added/deducted) accordingly → Pass/Fail.
- **BAC 4:** Merchant can sort logs by date or amount → Pass/Fail.
- **BAC 5:** Merchant can initiate a fiat top-up; on successful payment credit balance increases and a new transaction appears → Pass/Fail.
- **BAC 6:** Each transaction has a downloadable invoice/receipt (PDF) → Pass/Fail.
- **BAC 7:** All event sources (super admin charges, merchant top-ups, subscription renewals, order settlements, referral purchases) appear in the logs with correct linkage → Pass/Fail.
- **BAC 8:** Data is idempotent; duplicate callbacks or retries do not create duplicate credit entries → Pass/Fail.

---

### 6) **Data & Audit**

- **Credits Table**:
    - `id`
    - `merchant_id`
    - `type` (credit_add, credit_deduct)
    - `source` (admin_adjustment, merchant_topup, subscription, order, referral)
    - `title`
    - `description`
    - `amount`
    - `status`
    - `created_at`
    - `reference_id` (order_id, subscription_id, payment_id, etc.)
- **Balance Field**: Current credit balance updated after each confirmed transaction.
- **Invoice/Receipt**: Generated per transaction with amount, date, source, status, and merchant details.